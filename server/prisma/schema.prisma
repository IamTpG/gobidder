generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                   Int                    @id @default(autoincrement())
  full_name            String
  address              String?
  birthdate            DateTime?
  email                String                 @unique
  password_hash        String?
  google_id            String?                @unique
  role                 UserRole               @default(Bidder)
  is_email_verified    Boolean                @default(false)
  rating_plus          Int                    @default(0)
  rating_minus         Int                    @default(0)
  created_at           DateTime               @default(now())
  auto_bids            AutoBid[]
  banned_from_products BannedBidder[]
  bid_histories        BidHistory[]
  messages_received    ChatMessage[]          @relation("MessagesReceived")
  messages_sent        ChatMessage[]          @relation("MessagesSent")
  products_bidding_on  Product[]              @relation("CurrentHighestBidder")
  products_sold        Product[]              @relation("ProductsSold")
  questions_asked      QnA[]
  ratings_received     Rating[]               @relation("RatingsReceived")
  ratings_given        Rating[]               @relation("RatingsGiven")
  processed_requests   SellerUpgradeRequest[] @relation("AdminProcessor")
  upgrade_request      SellerUpgradeRequest?
  sold_transactions    Transaction[]          @relation("SoldTransactions")
  won_transactions     Transaction[]          @relation("WonTransactions")
  watchlist_items      WatchList[]

  @@index([email])
}

model Otp {
  id         Int      @id @default(autoincrement())
  email      String
  code       String
  expires_at DateTime

  @@index([email])
}

model SellerUpgradeRequest {
  id           Int           @id @default(autoincrement())
  user_id      Int           @unique
  status       RequestStatus @default(Pending)
  requested_at DateTime      @default(now())
  admin_id     Int?
  processed_by User?         @relation("AdminProcessor", fields: [admin_id], references: [id])
  user         User          @relation(fields: [user_id], references: [id], onDelete: Cascade)
}

model Category {
  id          Int        @id @default(autoincrement())
  name        String     @unique
  parent_id   Int?
  createdAt   DateTime   @default(now())
  description String?
  updatedAt   DateTime   @updatedAt
  parent      Category?  @relation("ParentChild", fields: [parent_id], references: [id])
  children    Category[] @relation("ParentChild")
  products    Product[]
}

model Product {
  id                Int            @id @default(autoincrement())
  name              String
  description       String
  images            Json
  created_at        DateTime       @default(now())
  end_time          DateTime
  start_price       BigInt
  step_price        BigInt
  buy_now_price     BigInt?
  auto_renew        Boolean        @default(false)
  status            ProductStatus  @default(Pending)
  current_price     BigInt
  bid_count         Int            @default(0)
  seller_id         Int
  category_id       Int
  current_bidder_id Int?
  auto_bids         AutoBid[]
  banned_bidders    BannedBidder[]
  bid_histories     BidHistory[]
  category          Category       @relation(fields: [category_id], references: [id])
  current_bidder    User?          @relation("CurrentHighestBidder", fields: [current_bidder_id], references: [id])
  seller            User           @relation("ProductsSold", fields: [seller_id], references: [id], onDelete: Cascade)
  qna_items         QnA[]
  transaction       Transaction?
  watchlist_users   WatchList[]

  @@index([end_time])
  @@index([bid_count])
  @@index([current_price])
  @@index([category_id])
  @@index([seller_id])
}

model AutoBid {
  id         Int      @id @default(autoincrement())
  user_id    Int
  product_id Int
  max_price  BigInt
  created_at DateTime @default(now())
  product    Product  @relation(fields: [product_id], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([user_id, product_id])
  @@index([product_id])
}

model BidHistory {
  id         Int      @id @default(autoincrement())
  product_id Int
  user_id    Int
  bid_price  BigInt
  created_at DateTime @default(now())
  product    Product  @relation(fields: [product_id], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([product_id])
}

model WatchList {
  user_id    Int
  product_id Int
  product    Product @relation(fields: [product_id], references: [id], onDelete: Cascade)
  user       User    @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@id([user_id, product_id])
}

model QnA {
  id            Int       @id @default(autoincrement())
  product_id    Int
  questioner_id Int
  question_text String
  question_time DateTime  @default(now())
  answer_text   String?
  answer_time   DateTime?
  product       Product   @relation(fields: [product_id], references: [id], onDelete: Cascade)
  questioner    User      @relation(fields: [questioner_id], references: [id], onDelete: Cascade)

  @@index([product_id])
}

model BannedBidder {
  product_id Int
  bidder_id  Int
  bidder     User    @relation(fields: [bidder_id], references: [id], onDelete: Cascade)
  product    Product @relation(fields: [product_id], references: [id], onDelete: Cascade)

  @@id([product_id, bidder_id])
}

model Transaction {
  id                   Int               @id @default(autoincrement())
  product_id           Int               @unique
  winner_id            Int
  seller_id            Int
  final_price          BigInt
  status               TransactionStatus @default(PendingPayment)
  created_at           DateTime          @default(now())
  shipping_address     String?
  payment_invoice_url  String?
  seller_confirmed_at  DateTime?
  shipping_invoice_url String?
  buyer_confirmed_at   DateTime?
  cancel_reason        String?
  messages             ChatMessage[]
  ratings              Rating[]
  product              Product           @relation(fields: [product_id], references: [id])
  seller               User              @relation("SoldTransactions", fields: [seller_id], references: [id])
  winner               User              @relation("WonTransactions", fields: [winner_id], references: [id])

  @@index([winner_id])
  @@index([seller_id])
}

model Rating {
  id             Int         @id @default(autoincrement())
  transaction_id Int
  rater_id       Int
  rated_user_id  Int
  score          RatingScore
  comment        String?
  created_at     DateTime    @default(now())
  rated_user     User        @relation("RatingsReceived", fields: [rated_user_id], references: [id], onDelete: NoAction)
  rater          User        @relation("RatingsGiven", fields: [rater_id], references: [id], onDelete: NoAction)
  transaction    Transaction @relation(fields: [transaction_id], references: [id])

  @@unique([transaction_id, rater_id])
  @@index([rated_user_id])
}

model ChatMessage {
  id             Int         @id @default(autoincrement())
  transaction_id Int
  sender_id      Int
  receiver_id    Int
  message        String
  created_at     DateTime    @default(now())
  receiver       User        @relation("MessagesReceived", fields: [receiver_id], references: [id], onDelete: NoAction)
  sender         User        @relation("MessagesSent", fields: [sender_id], references: [id], onDelete: NoAction)
  transaction    Transaction @relation(fields: [transaction_id], references: [id], onDelete: Cascade)

  @@index([transaction_id])
}

model RegistrationToken {
  id        String   @id
  email     String   @unique
  userType  String
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime
}

enum UserRole {
  Bidder
  Seller
  Admin
}

enum ProductStatus {
  Pending
  Active
  Sold
  Expired
  Removed
}

enum RequestStatus {
  Pending
  Approved
  Rejected
}

enum RatingScore {
  Positive
  Negative
}

enum TransactionStatus {
  PendingPayment
  PendingShipping
  PendingReceipt
  Completed
  Cancelled
}


model SystemConfig {
  id                     Int      @id @default(autoincrement())
  
  // 1. Cấu hình New Product sẽ highlight bao lâu
  new_product_duration   Int      @default(60) // Đơn vị: Phút
  
  // 2. Cấu hình Anti-Sniping (Bù giờ)
  anti_sniping_trigger   Int      @default(5)  // Kích hoạt khi còn X phút cuối
  anti_sniping_extension Int      @default(3)  // Cộng thêm Y phút
  
  updated_at             DateTime @updatedAt
}